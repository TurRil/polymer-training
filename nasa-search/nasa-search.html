<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../materializecss-styles/materializecss-styles.html">
<link rel="import" href="../hax-body-behaviors/hax-body-behaviors.html">
<link rel="import" href="../schema-behaviors/schema-behaviors.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="nasa-card.html">
<!--
`nasa-search`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -

-->

<dom-module id="nasa-search">
  <template>
    <style>
      :host {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      iron-list {
        flex: 1 1 auto;
      }

      #test {
        border: 1px solid #ccc;
        padding: 0.5rem;
        margin: 0.4rem;
      }

      .row {
        border: 1px solid red;
      }
    </style>
    <iron-ajax
      id="request"
      auto="[[autoUpdate]]"
      url="https://images-api.nasa.gov/search?media_type=image&q=[[searchValue]]"
      handle-as="json"
      last-response="{{responseObject}}"
      debounce-duration="300"></iron-ajax><!--on-response="handleResponse"-->

    <paper-checkbox checked="{{autoUpdate}}">Live update</paper-checkbox>
    <paper-input label="Search" type="search"
        placeholder="search for nasa images" value="{{searchValue}}">
    </paper-input>
    <paper-button id="button" raised class="indigo">Search</paper-button>
    <div id="test">[[searchValue]] [[autoUpdate]]</div>

    <iron-list items="[[images]]" as="image">
      <template>
        <nasa-card on-tap="tapped"
          title="[[image.data.0.title]]" 
          image="[[image.links.0.href]]" 
          description="[[image.data.0.description]]">
        </nasa-card>
      </template>
    </iron-list>
    <!--
    <template is="dom-repeat" items="[[images]]" as="image">
      <iron-image style="width:80px; height:80px;" sizing="cover"
        src="[[image.links.0.href]]"></iron-image>
    </template>
    -->

    <paper-dialog id="dialog">
      <h2>[[activeItem.title]]</h2>
      <img src="[[activeItem.image]]"/>
      <div>[[activeItem.description]]</div>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({

      is: 'nasa-search',
      behaviors: [HAXBehaviors.PropertiesBehaviors, MaterializeCSSBehaviors.ColorBehaviors, SchemaBehaviors.Schema],
      properties: {
        /*
         * Search Value
         */
         searchValue: {
           type: String,
           value: 'Venus',
         },
         /*
          * Do live update when the checkbox is ticked
          */
        autoUpdate: {
          type: Boolean,
          value: true,
        },
        images: {
          type: Array,
          value: [],
        },
        /*
         * Response object from nasa API
         */
        responseObject: {
          type: Object,
          observer: '_responseDataChanged'
        },
        /*
         * Active item to display in dialog
         */
         activeItem: {
          type: Object,
        }
      },
      listeners: {
        'button.tap': '_buttonTapped',
      },
      tapped: function(event) {
        var normalizeEvent = Polymer.dom(event);
        var local = normalizeEvent.localTarget;
        console.log(local.title);
        this.activeItem = {
          'image': local.image,
          'title': local.title,
          'description':  local.description,
        };
        this.$.dialog.toggle();
      },
      /**
       * use iron_ajax to now request the data when button is tapped
       */
      _buttonTapped: function(event) {
        console.log('tap');
        this.$.request.generateRequest();
      },
      /**
       * The response object updated
       */
      _responseDataChanged: function(newValue, oldValue) {
        console.log('data response');
        if (newValue) {
          console.log(newValue);
          this.images = newValue.collection.items
        }
      },
      /**
       * Attached to the DOM, now fire.
       */
      attached: function() {
        // Establish hax property binding
        let props = {
          'canScale': true,
          'canPosition': true,
          'canEditSource': false,
          'gizmo': {
            'title': 'Sample gizmo',
            'description': 'The user will be able to see this for selection in a UI.',
            'icon': 'av:play-circle-filled',
            'color': 'grey',
            'groups': ['Video', 'Media'],
            'handles': [
              {
                'type': 'video',
                'url': 'source'
              }
            ],
            'meta': {
              'author': 'Your organization on github'
            }
          },
          'settings': {
            'quick': [
              {
                'property': 'title',
                'title': 'Title',
                'description': 'The title of the element',
                'inputMethod': 'textfield',
                'icon': 'editor:title',
              },
            ],
            'configure': [
              {
                'property': 'title',
                'title': 'Title',
                'description': 'The title of the element',
                'inputMethod': 'textfield',
                'icon': 'editor:title',
              },
            ],
            'advanced': [
            ]
          }
        };
        this.setHaxProperties(props);
      },
    });
  </script>
</dom-module>
